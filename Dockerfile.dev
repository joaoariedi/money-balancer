FROM rust:1.78-slim AS build

WORKDIR /build

# Install system dependencies
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    build-essential \
    curl \
    && curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get install -y nodejs \
    && npm install -g yarn \
    && rm -rf /var/lib/apt/lists/*

# Copy all source code
COPY . .

# Build client first
RUN cd client && yarn install --frozen-lockfile && yarn build

# Build Rust application (build.rs will handle client build automatically)
RUN cargo build --release

# Runtime stage - use same base as build stage for GLIBC compatibility
FROM rust:1.78-slim
RUN apt-get update && apt-get install -y ca-certificates && rm -rf /var/lib/apt/lists/*
WORKDIR /data
ENV ROCKET_ADDRESS=0.0.0.0
ENV ROCKET_PORT=8000
COPY --from=build /build/target/release/money-balancer /money-balancer
EXPOSE 8000
VOLUME [ "/data" ]
ENTRYPOINT ["/money-balancer"]